# Ballot Check Subprotocol

This subprotocol covers the process where the Ballot Check Application interacts with the Voting Application to first authenticate itself and then confidentially retrieve the randomizers used to encrypt the ballot. This allows the Ballot Check Application to decrypt the encrypted and signed ballot posted to the Public Bulletin Board presenting the decrypted plaintext to the voter for manual verification of voter intent.

## Phase 1: Authenticate and Request

### Ballot Check Request Message

sender
: Ballot Check Application (BCA)

recipient
: Digital Ballot Box (DBB)

purpose
: Communicate to the VA the BCA's request to check a certain ballot. The DBB serves as an intermediary due to the challenges facing directly connecting two client devices across any possible network configuration. Importantly, the BCA embeds its public key both as an identifier for the voter to manually compare as an authentication mechanism and as a way to allow for the VA to establish confidential communication with the BCA.

***structure***

```rust
struct CheckReqMsg {
  election_hash : String, // Hash of the unique election configuration item.
  tracker : String, // Unique identifier corresponding to the Ballot Submission Bulletin entry on the bulletin board containing the ballot being requested for checking.
  public_enc_key : String, // Public key generated by the BCA.
  public_sign_key : String, // Public signing key generated by the BCA.
  signature : String, // A digital signature created by  BCA's signing key over the contents of this message.
}
```

### Ballot Check Request Checks

1. The `election_hash` is the hash of the election configuration item for the current election.
2. The `tracker` corresponds to a valid *Ballot Submission Bulletin* entry on the public bulletin board.
3. The `public_end_key` and `public_sign_key` are valid public keys for their respective cryptosystems.
4. The `signature` is a valid signature by the `public_sign_key` over the contents of this message.

### Forwarded Ballot Check Request Message

sender
: Digital Ballot Box (DBB)

recipient
: Voting Application (VA)

purpose
: To transmit the BCA's ballot check request to the VA after the DBB performs validation. This serves to limit the abuse possible by an adversary making repeated forged requests. Importantly, the DBB also signs this message asserting the DBB has performed validation allowing the VA to verify and accept requests that have also been approved by the DBB.

***structure***

```rust
struct FwdCheckReqMsg {
  election_hash : String, // Hash of the unique election configuration item.
  message : CheckReqMsg, // Check Request Message being forwarded
  signature : String, // A digital signature created by the digital ballot box's signing key over the contents of this message.
}
```

### Forwarded Ballot Check Request Checks

1. The `election_hash` is the hash of the election configuration item for the current election.
2. The `message` is a valid *Ballot Check Request Message*.
3. The `signature` is a valid signature by the digital ballot box signing key over the contents of this message.

## Phase 2: Randomizer Transmission

### Encrypted Randomizer Message

sender
: Voting Application (VA)

recipient
: Digital Ballot Box (DBB)

purpose
: Communicate the ciphertext of the randomizers (encrypted for the BCA public key) to the DBB so that the DBB can forward the ciphertext to the BCA. This occurs only after the VA validates the request and presents the public key of the BCA to the voter for a visual comparison with the public key displayed on the BCA as the authentication mechanism.

***structure***

```rust
struct RandomizerMsg {
  election_hash : String, // Hash of the unique election configuration item.
  message : CheckReqMsg, // Check Request Message this list of encrypted randomizers intends to satisfy.
  encrypted_randomizers : Vec<NaorYungCiphertext>, // Ciphertexts containing randomizers encrypted using the BCA public encryption key.
  public_key : String, // Public signing key generated by the VA.
  signature : String, // A digital signature created by the VA's signing key over the contents of this message.
}

struct NaorYungCiphertext {
  c1 : String, // First component of the Naor-Yung ciphertext
  c2 : String, // Second component of the Naor-Yung ciphertext
  pi : String, // Proof component of the Naor-Yung ciphertext
}
```

### Encrypted Randomizer Checks

1. The `election_hash` is the hash of the election configuration item for the current election.
2. The `message` is a valid *Ballot Check Request Message*.
3. Each ciphertext in the `encrypted_randomizers` list is a valid Naor-Yung ciphertext.
4. The `encrypted_randomizers` list is equal in length to the number of items in the ballot style of the `tracker` in the `message`.
5. The `public_key` matches the `public_key` in the *Ballot Submission Bulletin* corresponding to the `tracker` in the `message`.
6. The `signature` is a valid signature over the contents of the message signed by the `public_key`.

### Encrypted Randomizer Forwarding Message

sender
: Digital Ballot Box (DBB)

recipient
: Ballot Check Application (BCA)

purpose
: To forward along the ciphertext containing the randomizers used for the ballot being checked. The DBB only forwards this message along after verifying it is being sent by the VA who cast the ballot being checked.

***structure***

```rust
struct FwdRandomizerMsg {
  election_hash : String, // Hash of the unique election configuration item.
  message : RandomizerMsg, // Randomizer Transmission Message being forwarded
  signature : String, // A digital signature created by the digital ballot box's signing key over the contents of this message.
}
```

### Encrypted Randomizer Forwarding Checks

1. The `election_hash` is the hash of the election configuration item for the current election.
2. The `message` is a valid *Encrypted Randomizer Forwarding Message*.
3. The `signature` is a valid signature by the digital ballot box signing key over the contents of this message.

## Phase 3: Decryption and Comparison

The BCA uses its private key to decrypt the ciphertext containing the randomizers. The BCA uses the plaintext randomizers to reconstruct the plaintext ballot selections. These plaintext ballot selections are presented to the user using the display of the BCA for a manual check of voter intent.

## Ballot Check Application Process Diagram

```mermaid
    stateDiagram-v2
      request : Send **Ballot Check Request Message**
      fwd_random : Receive **Encrypted Randomizer Forwarding Message**

      complete : **Success** Ballot Check Application has Decrypted Ballot
      error : **Failure** Protocol Aborted with Error Message

      [*] --> request

      request --> fwd_random

      fwd_random --> complete
      fwd_random --> error : Timeout Exceeded Error
      fwd_random --> error : Randomizer Decryption Failure Error
      fwd_random --> error : Ballot Cryptogram Decryption Failure Error
      fwd_random --> error : Invalid Ballot Cryptogram Plaintext

      complete --> [*]
      error --> [*]
```

## Voting Application Process Diagram

```mermaid
    stateDiagram-v2
      fwd_request : Receive **Forwarded Ballot Check Request Message**
      random : Send **Encrypted Randomizer Message**

      complete : **Success** Ballot Check Application has Decrypted Ballot
      error : **Failure** Protocol Aborted with Error Message
      denied : **Success** Voting Application Denies a Request Unwanted by the Voter


      [*] --> fwd_request

      fwd_request --> random
      fwd_request --> denied : Voter Denies Ballot Check Request
      fwd_request --> error : Timeout Exceeded Error
      fwd_request --> error : Incorrect Election Error
      fwd_request --> error : Invalid Ballot Cryptogram Reference Error

      random --> complete
      random --> error : Ballot Check Application Public Key Invalid Error
      random --> error : Randomizers Unable to be Retrieved from Memory Error


      complete --> [*]
      denied --> [*]
      error --> [*]
```

## Digital Ballot Box Process Diagram

```mermaid
    stateDiagram-v2
      request : Receive **Ballot Check Request Message**
      fwd_request : Send **Forwarded Ballot Check Request Message**
      random : Receive **Encrypted Randomizer Message**
      fwd_random : Send **Encrypted Randomizer Forwarding Message**

      complete : **Success** Ballot Check Application has Decrypted Ballot
      error : **Failure** Protocol Aborted with Error Message


      [*] --> request

      request --> fwd_request
      request --> error : Timeout Exceeded Error
      request --> error : Invalid Ballot Tracker Reference
      request --> error : Ballot Already Cast Error
      request --> error : Ballot Does Not Exist Error
      request --> error : Incorrect Signature Error
      request --> error : Invalid Signature Error

      fwd_request --> random

      random --> fwd_random
      random --> error : Timeout Exceeded Error
      random --> error : Invalid Signature Error
      random --> error : Invalid Ballot Tracker Reference Error
      random --> error : Ballot Now Cast Error

      fwd_random --> complete


      complete --> [*]
      error --> [*]
```
